<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Asset Deviation Tracker (Multiple Instances)</title>
  <!-- Make pages scale nicely on phones -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- jsPDF from CDN for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Global styling with gradient background and emojis */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
      background: linear-gradient(to bottom right, #f0f0f0, #ffffff);
    }
    /* Add an emoji before the title */
    h1:before {
      content: "üì∏ ";
    }
    h1, h2 {
      text-align: center;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    form, .buttons {
      margin: 20px 0;
      text-align: center;
    }
    label {
      display: block;
      margin: 5px 0 2px;
      font-weight: bold;
    }
    select, input, button, textarea {
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
      font-size: 1rem;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    textarea {
      resize: vertical;
    }
    button {
      cursor: pointer;
      border: none;
      background-color: #0078d7;
      color: white;
      padding: 8px 12px;
      font-size: 1rem;
      border-radius: 4px;
      margin: 5px;
    }
    button:hover {
      background-color: #005fab;
    }
    /* Table styling */
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      border-radius: 4px;
      overflow: hidden;
    }
    table thead tr {
      background-color: #f7f7f7;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      vertical-align: top;
    }
    th {
      background: #f9f9f9;
    }
    /* Emoji icons in table headers */
    th:nth-child(1)::before { content: "üî¢ "; }
    th:nth-child(2)::before { content: "üì∏ "; }
    th:nth-child(3)::before { content: "‚ùó "; }
    th:nth-child(4)::before { content: "üõ†Ô∏è "; }
    th:nth-child(5)::before { content: "‚ö†Ô∏è "; }
    /* Hover effect for table rows */
    tbody tr:hover {
      background-color: #fafafa;
    }
    img {
      max-width: 120px;
      height: auto;
      display: block;
      margin: 0 auto;
    }
    /* Responsive table for smaller screens */
    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr {
        display: block;
        width: 100%;
      }
      thead {
        display: none;
      }
      tr {
        margin-bottom: 20px;
        border: 1px solid #ccc;
      }
      td {
        border: none;
        padding: 5px 0;
      }
      td:before {
        content: attr(data-label);
        font-weight: bold;
        display: block;
      }
      img {
        max-width: 80px;
      }
    }
  </style>
</head>
<body>
  <h1>Asset Deviation Tracker</h1>

  <!-- 1) INSTANCE SELECTION -->
  <div style="text-align:center; margin-bottom: 15px;">
    <label for="instanceSelect">Select or Create an Instance:</label>
    <select id="instanceSelect">
      <!-- Built-in sample instances -->
      <option value="Default">Default</option>
      <option value="ProjectA">ProjectA</option>
      <option value="ProjectB">ProjectB</option>
      <!-- Others can be added manually or typed below -->
    </select>
    <!-- Input for a custom instance name -->
    <input type="text" id="newInstanceInput" placeholder="New Instance Name" style="width:auto; display:inline-block;" />
    <button id="addInstanceBtn">Add Instance</button>
  </div>
  
  <!-- Asset Code input with datalist -->
  <label for="searchCodeInput">Asset Code (Search or type custom):</label>
  <input type="text" id="searchCodeInput" placeholder="e.g. 131-CON-01..." list="codeSuggestions" />
  <datalist id="codeSuggestions"></datalist>

  <!-- The Add Entry form -->
  <form id="entryForm">
    <label for="imageInput">Photo:</label>
    <input type="file" id="imageInput" accept="image/*;capture=camera" required>
    
    <label for="deviationInput">Deviation:</label>
    <textarea id="deviationInput" rows="2" placeholder="Describe the deviation" required></textarea>
    
    <label for="criticalityInput">Criticality:</label>
    <select id="criticalityInput" required>
      <option value="">Select Criticality</option>
      <option value="Low">Low</option>
      <option value="Medium">Medium</option>
      <option value="High">High</option>
    </select>
    
    <label for="remedialInput">Remedial Action:</label>
    <textarea id="remedialInput" rows="2" placeholder="e.g. Fix, Replace" required></textarea>
    <button type="submit">Add Entry</button>
  </form>

  <div class="buttons">
    <!-- PDF Orientation Selector -->
    <label for="pdfOrientation">PDF Orientation:</label>
    <select id="pdfOrientation">
      <option value="l">Landscape</option>
      <option value="p">Portrait</option>
    </select>
    <button id="generatePdf">Generate PDF</button>
    <button id="exportCsv">Export CSV</button>
    <button id="clearAll">Clear All Entries</button>
  </div>

  <h2>Existing Entries</h2>
  <table id="entriesTable">
    <thead>
      <tr>
        <th>Asset Code</th>
        <th>Photo</th>
        <th>Deviation</th>
        <th>Remedial Action</th>
        <th>Criticality</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    ////////////////////////////////////////////////////////////////////////////
    // GLOBALS
    ////////////////////////////////////////////////////////////////////////////
    let db;                 // The IndexedDB handle
    let entries = [];       // In-memory array for the current instance's entries
    let currentInstance = 'Default'; // default instance name at startup

    // Database name & version stay the same, but we'll have 1 object store *per instance*.
    const DB_NAME = 'DeviationsDB_Multi';
    const DB_VERSION = 1;

    // We'll keep track of which object stores exist, so we can create them on-the-fly if needed.
    const knownStoresKey = '__knownStores';  // name of the "meta" store or data

    // For asset code suggestions
    let allCodes = [];

    ////////////////////////////////////////////////////////////////////////////
    // DOM Elements
    ////////////////////////////////////////////////////////////////////////////
    const instanceSelect      = document.getElementById('instanceSelect');
    const newInstanceInput    = document.getElementById('newInstanceInput');
    const addInstanceBtn      = document.getElementById('addInstanceBtn');

    const searchCodeInput     = document.getElementById('searchCodeInput');
    const codeSuggestions     = document.getElementById('codeSuggestions');
    const entryForm           = document.getElementById('entryForm');
    const imageInput          = document.getElementById('imageInput');
    const deviationInput      = document.getElementById('deviationInput');
    const criticalityInput    = document.getElementById('criticalityInput');
    const remedialInput       = document.getElementById('remedialInput');
    const entriesTableBody    = document.querySelector('#entriesTable tbody');
    const generatePdfButton   = document.getElementById('generatePdf');
    const clearAllButton      = document.getElementById('clearAll');
    const pdfOrientationSelect= document.getElementById('pdfOrientation');

    ////////////////////////////////////////////////////////////////////////////
    // 1) OPEN or UPGRADE THE DATABASE
    ////////////////////////////////////////////////////////////////////////////
    function openDatabase() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = event => {
          console.error("Database error:", event.target.error);
          reject(event.target.error);
        };
        request.onupgradeneeded = event => {
          db = event.target.result;
          // Possibly create a store to keep track of known stores
          if (!db.objectStoreNames.contains(knownStoresKey)) {
            db.createObjectStore(knownStoresKey, { keyPath: 'name' });
          }
        };
        request.onsuccess = event => {
          db = event.target.result;
          resolve(db);
        };
      });
    }

    ////////////////////////////////////////////////////////////////////////////
    // 2) Ensure the object store for the CURRENT instance
    ////////////////////////////////////////////////////////////////////////////
    function ensureStoreExists(storeName) {
      return new Promise((resolve, reject) => {
        // If storeName doesn't exist, we need to close the DB, reopen with onupgradeneeded
        if (db.objectStoreNames.contains(storeName)) {
          // Already exists
          resolve();
        } else {
          db.close();
          const req = indexedDB.open(DB_NAME, db.version + 1);
          req.onupgradeneeded = event => {
            const upgradeDB = event.target.result;
            if (!upgradeDB.objectStoreNames.contains(storeName)) {
              upgradeDB.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
            }
          };
          req.onsuccess = event => {
            db = event.target.result;
            resolve();
          };
          req.onerror = event => {
            reject(event.target.error);
          };
        }
      });
    }

    ////////////////////////////////////////////////////////////////////////////
    // 3) Store-level operations (CRUD)
    ////////////////////////////////////////////////////////////////////////////
    function getAllEntries(storeName) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readonly');
        const store = transaction.objectStore(storeName);
        const request = store.getAll();
        request.onsuccess = event => resolve(event.target.result);
        request.onerror = event => reject(event.target.error);
      });
    }

    function addEntry(storeName, entry) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.add(entry);
        request.onsuccess = event => {
          entry.id = event.target.result;
          resolve(entry);
        };
        request.onerror = event => reject(event.target.error);
      });
    }

    function updateEntry(storeName, entry) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.put(entry);
        request.onsuccess = () => resolve();
        request.onerror = event => reject(event.target.error);
      });
    }

    function removeEntry(storeName, id) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.delete(id);
        request.onsuccess = () => resolve();
        request.onerror = event => reject(event.target.error);
      });
    }

    function clearAllEntries(storeName) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.clear();
        request.onsuccess = () => resolve();
        request.onerror = event => reject(event.target.error);
      });
    }

    ////////////////////////////////////////////////////////////////////////////
    // 4) Refresh the in-memory array from current instance store and re-render
    ////////////////////////////////////////////////////////////////////////////
    async function refreshEntries() {
      try {
        entries = await getAllEntries(currentInstance);
        renderEntries();
      } catch (err) {
        console.error("Error refreshing entries:", err);
      }
    }

    ////////////////////////////////////////////////////////////////////////////
    // 5) RENDER table
    ////////////////////////////////////////////////////////////////////////////
    function renderEntries() {
      entriesTableBody.innerHTML = '';
      const filterText = searchCodeInput.value.trim().toLowerCase();
      let rowsToShow = filterText
        ? entries.filter(e => e.assetCode.toLowerCase().includes(filterText))
        : entries;
      // Limit to 50 for performance
      rowsToShow = rowsToShow.slice(0, 50);

      rowsToShow.forEach(entry => {
        const row = document.createElement('tr');

        // Asset Code
        const assetTd = document.createElement('td');
        assetTd.setAttribute('data-label', 'Asset Code');
        const assetArea = document.createElement('textarea');
        assetArea.value = entry.assetCode;
        assetArea.rows = 1;
        assetArea.style.width = '100%';
        assetArea.oninput = () => {
          entry.assetCode = assetArea.value;
          updateEntry(currentInstance, entry).catch(err => console.error("Error updating entry:", err));
        };
        assetTd.appendChild(assetArea);
        row.appendChild(assetTd);

        // Photo
        const photoTd = document.createElement('td');
        photoTd.setAttribute('data-label', 'Photo');
        const img = document.createElement('img');
        img.src = entry.image;
        photoTd.appendChild(img);
        row.appendChild(photoTd);

        // Deviation
        const deviationTd = document.createElement('td');
        deviationTd.setAttribute('data-label', 'Deviation');
        const devArea = document.createElement('textarea');
        devArea.value = entry.deviation;
        devArea.rows = 2;
        devArea.style.width = '100%';
        devArea.oninput = () => {
          entry.deviation = devArea.value;
          updateEntry(currentInstance, entry).catch(err => console.error("Error updating entry:", err));
        };
        deviationTd.appendChild(devArea);
        row.appendChild(deviationTd);

        // Remedial
        const remedTd = document.createElement('td');
        remedTd.setAttribute('data-label', 'Remedial Action');
        const remedArea = document.createElement('textarea');
        remedArea.value = entry.remedial;
        remedArea.rows = 2;
        remedArea.style.width = '100%';
        remedArea.oninput = () => {
          entry.remedial = remedArea.value;
          updateEntry(currentInstance, entry).catch(err => console.error("Error updating entry:", err));
        };
        remedTd.appendChild(remedArea);
        row.appendChild(remedTd);

        // Criticality
        const critTd = document.createElement('td');
        critTd.setAttribute('data-label', 'Criticality');
        const critArea = document.createElement('textarea');
        critArea.value = entry.criticality;
        critArea.rows = 1;
        critArea.style.width = '100%';
        critArea.oninput = () => {
          entry.criticality = critArea.value;
          updateEntry(currentInstance, entry).catch(err => console.error("Error updating entry:", err));
        };
        critTd.appendChild(critArea);
        row.appendChild(critTd);

        // Actions
        const actionsTd = document.createElement('td');
        actionsTd.setAttribute('data-label', 'Actions');
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => {
          if (confirm("Are you sure you want to delete this entry?")) {
            removeEntry(currentInstance, entry.id)
              .then(() => refreshEntries())
              .catch(err => console.error("Error deleting entry:", err));
          }
        };
        actionsTd.appendChild(deleteBtn);
        row.appendChild(actionsTd);

        entriesTableBody.appendChild(row);
      });
    }

    ////////////////////////////////////////////////////////////////////////////
    // 6) UTILITY: Debounce function
    ////////////////////////////////////////////////////////////////////////////
    function debounce(fn, delay) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), delay);
      };
    }

    ////////////////////////////////////////////////////////////////////////////
    // 7) Asset Codes from assetCodes.txt (optional)
    ////////////////////////////////////////////////////////////////////////////
    // If you don't have or need this, you can remove it or adapt to your usage
    fetch('assetCodes.txt')
      .then(res => {
        if (!res.ok) throw new Error('Could not load assetCodes.txt');
        return res.text();
      })
      .then(data => {
        allCodes = data.split('\n').map(line => line.trim()).filter(line => line !== '');
      })
      .catch(err => console.error(err));

    function updateCodeSuggestions() {
      codeSuggestions.innerHTML = '';
      const typed = searchCodeInput.value.trim().toLowerCase();
      const matched = typed
        ? allCodes.filter(code => code.toLowerCase().includes(typed))
        : allCodes;
      const MAX_SUGGESTIONS = 50;
      matched.slice(0, MAX_SUGGESTIONS).forEach(code => {
        const opt = document.createElement('option');
        opt.value = code;
        codeSuggestions.appendChild(opt);
      });
    }

    // Filter & re-render upon searching
    const handleSearch = debounce(() => {
      updateCodeSuggestions();
      renderEntries();
    }, 800);
    searchCodeInput.addEventListener('input', handleSearch);

    ////////////////////////////////////////////////////////////////////////////
    // 8) ADD NEW ENTRY (via form)
    ////////////////////////////////////////////////////////////////////////////
    entryForm.addEventListener('submit', e => {
      e.preventDefault();
      const code       = searchCodeInput.value.trim();
      const file       = imageInput.files[0];
      const deviation  = deviationInput.value.trim();
      const criticality= criticalityInput.value.trim();
      const remedial   = remedialInput.value.trim();

      if (!code) {
        alert('Please type or pick an Asset Code before adding an entry.');
        return;
      }
      if (!file) {
        alert('Please select a photo.');
        return;
      }
      if (!deviation || !criticality || !remedial) {
        alert('Fill out all fields (Deviation, Criticality, Remedial).');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(evt) {
        const imageData = evt.target.result;
        const newEntry = {
          assetCode: code,
          image: imageData,
          deviation: deviation,
          remedial: remedial,
          criticality: criticality,
          timestamp: Date.now()
        };
        addEntry(currentInstance, newEntry)
          .then(() => {
            // Clear form
            imageInput.value = '';
            deviationInput.value = '';
            criticalityInput.value = '';
            remedialInput.value = '';
            // Refresh
            refreshEntries();
          })
          .catch(err => console.error("Error adding entry:", err));
      };
      reader.readAsDataURL(file);
    });

    ////////////////////////////////////////////////////////////////////////////
    // 9) CLEAR ALL from the current instance
    ////////////////////////////////////////////////////////////////////////////
    clearAllButton.addEventListener('click', async () => {
      if (!entries.length) {
        alert("No entries to clear in this instance.");
        return;
      }
      if (confirm(`Are you sure you want to clear all entries in "${currentInstance}"? This cannot be undone.`)) {
        try {
          await clearAllEntries(currentInstance);
          refreshEntries();
        } catch (err) {
          console.error("Error clearing entries:", err);
        }
      }
    });

    ////////////////////////////////////////////////////////////////////////////
    // 10) GENERATE PDF with the current instance's data
    ////////////////////////////////////////////////////////////////////////////
    generatePdfButton.addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const orientation = pdfOrientationSelect.value; // 'l' or 'p'
      const doc = new jsPDF(orientation, 'pt', 'letter');
      const pageWidth  = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin  = 40;
      const startX  = margin;
      let currentY  = margin;

      doc.setFontSize(14);
      doc.text(`Deviation Table - Instance: ${currentInstance}`, startX, currentY);
      currentY += 20;

      const filterText = searchCodeInput.value.trim().toLowerCase();
      const pdfEntries = filterText
        ? entries.filter(e => e.assetCode.toLowerCase().includes(filterText))
        : entries;

      // Simple layout approach: one record per "block"
      pdfEntries.forEach((entry, idx) => {
        if (currentY > pageHeight - margin - 120) {
          doc.addPage();
          currentY = margin;
        }
        doc.setFontSize(12);
        doc.text(`(${idx + 1}) Asset Code: ${entry.assetCode}`, startX, currentY);
        currentY += 14;
        doc.text(`Deviation: ${entry.deviation}`, startX, currentY);
        currentY += 14;
        doc.text(`Remedial: ${entry.remedial}`, startX, currentY);
        currentY += 14;
        doc.text(`Criticality: ${entry.criticality}`, startX, currentY);
        currentY += 14;

        // Attempt to add image
        try {
          const isPng = (entry.image || '').toLowerCase().includes('image/png');
          const format = isPng ? 'PNG' : 'JPEG';
          const props = doc.getImageProperties(entry.image);
          const maxImgW = 200;
          const maxImgH = 120;
          let iWidth  = props.width;
          let iHeight = props.height;
          const ratio = Math.min(maxImgW / iWidth, maxImgH / iHeight);
          iWidth  *= ratio;
          iHeight *= ratio;
          doc.addImage(entry.image, format, startX, currentY, iWidth, iHeight);
          currentY += iHeight + 10;
        } catch (err) {
          currentY += 10;
          console.error("Image error:", err);
        }
        currentY += 10;
      });

      doc.save(`deviation_tracker_${currentInstance}.pdf`);
    });

    ////////////////////////////////////////////////////////////////////////////
    // 11) MULTIPLE INSTANCES: Changing the current instance
    ////////////////////////////////////////////////////////////////////////////
    instanceSelect.addEventListener('change', () => {
      currentInstance = instanceSelect.value;
      // Ensure store exists, then load data
      ensureStoreExists(currentInstance)
        .then(() => refreshEntries())
        .catch(err => console.error("Error ensuring store:", err));
    });

    // Add a new instance from user input
    addInstanceBtn.addEventListener('click', () => {
      const name = newInstanceInput.value.trim();
      if (!name) {
        alert("Enter a valid instance name.");
        return;
      }
      // Add to the <select>
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      instanceSelect.appendChild(opt);
      instanceSelect.value = name;
      currentInstance = name;
      newInstanceInput.value = '';
      // Create new store if needed
      ensureStoreExists(currentInstance)
        .then(() => refreshEntries())
        .catch(err => console.error("Error ensuring store:", err));
    });

    ////////////////////////////////////////////////////////////////////////////
    // 12) On page load, open DB and ensure default store, then load entries
    ////////////////////////////////////////////////////////////////////////////
    window.addEventListener('DOMContentLoaded', () => {
      openDatabase()
        .then(() => ensureStoreExists(currentInstance))
        .then(() => refreshEntries())
        .catch(err => console.error("Failed to open DB or ensure store:", err));
    });
  </script>
</body>
</html>
