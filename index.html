<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Non-conformance Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 10px;
      background: #f8f9fa;
      line-height: 1.6;
    }

    h1, h2 {
      text-align: center;
      margin: 15px 0;
      font-weight: 600;
    }

    h1 { font-size: 1.8rem; color: #1a73e8; }
    h2 { font-size: 1.4rem; }

    form, .buttons {
      margin: 15px 0;
      padding: 10px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: 500;
      color: #202124;
      font-size: 0.95rem;
    }

    input, select, button, textarea {
      width: 100%;
      padding: 12px;
      margin: 5px 0 15px;
      border: 1px solid #dadce0;
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      box-sizing: border-box;
    }

    button {
      background-color: #1a73e8;
      color: white;
      font-weight: 500;
      padding: 14px;
      border: none;
      transition: all 0.2s ease;
    }

    button:hover { background-color: #1557b0; }
    #clearAll { background-color: #dc3545; }
    #clearAll:hover { background-color: #bb2d3b; }

    .criticality-low { color: #28a745; }
    .criticality-medium { color: #ffc107; }
    .criticality-high { color: #dc3545; }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th { background-color: #f8f9fa; font-weight: 600; }
    img { max-width: 100px; height: auto; border-radius: 4px; }
    textarea { resize: vertical; min-height: 80px; font-family: inherit; }

    @media (max-width: 768px) {
      .buttons { flex-direction: column; }
      button { margin: 5px 0; }
      table thead { display: none; }
      table tr { display: block; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; }
      table td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        text-align: right;
        padding: 10px;
        border: none;
      }
      table td::before {
        content: attr(data-label);
        font-weight: 500;
        color: #5f6368;
        margin-right: 15px;
        flex: 1;
        text-align: left;
      }
      table td textarea { width: 90%; margin: 5px auto; padding: 8px; }
      table td img { max-width: 80px; margin: 0 auto; }
      table td:last-child { border-bottom: 0; }
    }
  </style>
</head>
<body>
  <h1>Non-conformance Tracker</h1>
  
  <label for="searchCodeInput">Asset Code:</label>
  <input type="text" id="searchCodeInput" placeholder="Search or type code..." list="codeSuggestions" />
  <datalist id="codeSuggestions"></datalist>

  <form id="entryForm">
    <label for="imageInput">üì∏ Photo</label>
    <input type="file" id="imageInput" accept="image/*" capture="environment" required>
    
    <label for="nonConformanceInput">‚ö†Ô∏è Non-conformance</label>
    <textarea id="nonConformanceInput" placeholder="Describe non-conformance..." required></textarea>
    
    <label for="criticalityInput">üö® Criticality</label>
    <select id="criticalityInput" required>
      <option value="low">Low</option>
      <option value="medium">Medium</option>
      <option value="high">High</option>
    </select>
    
    <label for="remedialInput">üîß Remedial Action</label>
    <textarea id="remedialInput" placeholder="Required corrective action..." required></textarea>
    
    <button type="submit">‚ûï Add Entry</button>
  </form>

  <div class="buttons">
    <button id="generatePdf">üìÑ Generate PDF</button>
    <button id="clearAll">‚ùå Clear All</button>
  </div>

  <h2>Existing Entries</h2>
  <table id="entriesTable">
    <thead>
      <tr>
        <th>Asset Code</th>
        <th>Photo</th>
        <th>Non-conformance</th>
        <th>Criticality</th>
        <th>Remedial Action</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const DB_NAME = 'NonConformanceDB';
    const DB_VERSION = 2;
    const STORE_NAME = 'entries';
    let db;
    let entries = [];

    // Database setup
    function openDatabase() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = event => reject(event.target.error);
        request.onupgradeneeded = event => {
          db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
          }
        };
        request.onsuccess = event => {
          db = event.target.result;
          resolve(db);
        };
      });
    }

    async function getAllEntriesFromDB() {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        store.getAll().onsuccess = event => resolve(event.target.result);
      });
    }

    async function addEntryToDB(entry) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        store.add(entry).onsuccess = event => {
          entry.id = event.target.result;
          resolve(entry);
        };
      });
    }

    async function removeEntryFromDB(id) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        transaction.objectStore(STORE_NAME).delete(id).onsuccess = resolve;
      });
    }

    // Image handling
    async function compressImage(imageData, maxWidth = 1200, maxHeight = 900) {
      return new Promise(resolve => {
        const img = new Image();
        img.src = imageData;
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;

          if (width > height) {
            if (width > maxWidth) {
              height *= maxWidth / width;
              width = maxWidth;
            }
          } else {
            if (height > maxHeight) {
              width *= maxHeight / height;
              height = maxHeight;
            }
          }

          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          resolve(canvas.toDataURL('image/jpeg', 0.8));
        };
      });
    }

    // UI components
    async function refreshEntries() {
      entries = await getAllEntriesFromDB();
      renderEntries();
    }

    function renderEntries() {
      const tbody = document.querySelector('#entriesTable tbody');
      tbody.innerHTML = '';
      
      entries.forEach(entry => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td data-label="Asset Code">
            <textarea>${entry.assetCode}</textarea>
          </td>
          <td data-label="Photo"><img src="${entry.image}"></td>
          <td data-label="Non-conformance">
            <textarea>${entry.nonConformance}</textarea>
          </td>
          <td data-label="Criticality" class="criticality-${entry.criticality}">
            ${entry.criticality.toUpperCase()}
          </td>
          <td data-label="Remedial Action">
            <textarea>${entry.remedial}</textarea>
          </td>
          <td data-label="Actions">
            <button onclick="deleteEntry(${entry.id})">Delete</button>
          </td>
        `;

        row.querySelectorAll('textarea').forEach(textarea => {
          textarea.addEventListener('input', () => updateEntry(entry.id, textarea));
        });

        tbody.appendChild(row);
      });
    }

    async function updateEntry(id, element) {
      const entry = entries.find(e => e.id === id);
      entry[element.parentElement.getAttribute('data-label').toLowerCase().replace(' ', '')] = element.value;
      const transaction = db.transaction([STORE_NAME], 'readwrite');
      transaction.objectStore(STORE_NAME).put(entry);
    }

    window.deleteEntry = async id => {
      if (confirm('Delete this entry?')) {
        await removeEntryFromDB(id);
        await refreshEntries();
      }
    };

    // PDF Generation
    document.getElementById('generatePdf').addEventListener('click', async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'pt', 'letter');
      const pageHeight = doc.internal.pageSize.height;
      const marginY = 40;
      let currentY = marginY;
      const colWidths = [70, 300, 150, 80, 150];
      const rowHeight = 180;

      function checkPageBreak() {
        if (currentY + rowHeight > pageHeight - marginY) {
          doc.addPage();
          currentY = marginY;
          return true;
        }
        return false;
      }

      function drawHeader() {
        doc.setFontSize(14);
        doc.text('Non-conformance Report', 40, currentY);
        currentY += 30;
        doc.setFontSize(12);
        doc.text('Asset Code', 40, currentY);
        doc.text('Photo', 110, currentY);
        doc.text('Non-conformance', 410, currentY);
        doc.text('Criticality', 560, currentY);
        doc.text('Remedial Action', 640, currentY);
        currentY += 20;
      }

      drawHeader();

      for (const entry of entries) {
        checkPageBreak();
        
        // Compress and add image
        const compressedImage = await compressImage(entry.image);
        const imgProps = doc.getImageProperties(compressedImage);
        const imgWidth = 250;
        const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
        
        doc.addImage(compressedImage, 'JPEG', 110, currentY + 10, imgWidth, imgHeight);
        
        // Add other fields
        doc.setFontSize(10);
        doc.text(entry.assetCode, 40, currentY + 20, { maxWidth: 60 });
        doc.text(entry.nonConformance, 410, currentY + 20, { maxWidth: 140 });
        doc.text(entry.criticality.toUpperCase(), 560, currentY + 20);
        doc.text(entry.remedial, 640, currentY + 20, { maxWidth: 140 });
        
        currentY += rowHeight;
        if (currentY < pageHeight - marginY) {
          doc.line(40, currentY, 770, currentY);
        }
      }

      doc.save('non-conformance-report.pdf');
    });

    // Event Listeners
    document.getElementById('clearAll').addEventListener('click', async () => {
      if (confirm('Clear ALL entries?')) {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        transaction.objectStore(STORE_NAME).clear();
        entries = [];
        renderEntries();
      }
    });

    document.getElementById('entryForm').addEventListener('submit', async e => {
      e.preventDefault();
      const reader = new FileReader();
      reader.onload = async e => {
        const entry = {
          assetCode: document.getElementById('searchCodeInput').value.trim(),
          image: await compressImage(e.target.result),
          nonConformance: document.getElementById('nonConformanceInput').value.trim(),
          criticality: document.getElementById('criticalityInput').value,
          remedial: document.getElementById('remedialInput').value.trim()
        };
        await addEntryToDB(entry);
        await refreshEntries();
        e.target.form.reset();
      };
      reader.readAsDataURL(document.getElementById('imageInput').files[0]);
    });

    // Initialize
    openDatabase().then(refreshEntries);
  </script>
</body>
</html>