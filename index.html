<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Non-Conformance Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 10px;
      background: #f8f9fa;
      line-height: 1.6;
    }
    h1, h2 {
      text-align: center;
      margin: 15px 0;
      font-weight: 600;
    }
    h1 {
      font-size: 1.8rem;
      color: #1a73e8;
    }
    form, .buttons {
      margin: 15px 0;
      padding: 10px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: 500;
      color: #202124;
      font-size: 0.95rem;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 12px;
      margin: 5px 0 15px;
      border: 1px solid #dadce0;
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      box-sizing: border-box;
    }
    button {
      background-color: #1a73e8;
      color: white;
      padding: 14px;
      border: none;
      transition: all 0.2s ease;
    }
    #clearAll {
      background-color: #dc3545;
    }
    /* Criticality colors */
    .criticality-low { color: #28a745; }
    .criticality-medium { color: #ffc107; }
    .criticality-high { color: #dc3545; }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      border-radius: 4px;
      overflow: hidden;
    }
    table thead tr {
      background-color: #f7f7f7;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      vertical-align: top;
    }
    th {
      background: #f9f9f9;
    }
    tbody tr:hover {
      background-color: #fafafa;
    }
    img {
      max-width: 120px;
      height: auto;
      display: block;
      margin: 0 auto;
    }
    @media (max-width: 768px) {
      table tr { display: block; margin-bottom: 15px; }
      table td { display: flex; justify-content: space-between; }
      table td::before { content: attr(data-label); font-weight: 500; }
    }
  </style>
</head>
<body>
  <h1>Non-Conformance Tracker</h1>
  
  <label for="searchCodeInput">Asset Code:</label>
  <input type="text" id="searchCodeInput" placeholder="Search..." list="codeSuggestions" />
  <datalist id="codeSuggestions"></datalist>
  
  <form id="entryForm">
    <label for="imageInput">üì∏ Photo</label>
    <input type="file" id="imageInput" accept="image/*" capture="environment" required>
    
    <label for="nonConformanceInput">‚ö†Ô∏è Non-conformance</label>
    <textarea id="nonConformanceInput" required></textarea>
    
    <label for="criticalityInput">üö® Criticality</label>
    <select id="criticalityInput" required>
      <option value="low">Low</option>
      <option value="medium">Medium</option>
      <option value="high">High</option>
    </select>
    
    <label for="remedialInput">üîß Remedial Action</label>
    <textarea id="remedialInput" required></textarea>
    
    <button type="submit">‚ûï Add Entry</button>
  </form>
  
  <div class="buttons">
    <button id="generatePdf">üìÑ Generate PDF</button>
    <button id="clearAll">‚ùå Clear All</button>
  </div>
  
  <h2>Existing Entries</h2>
  <table id="entriesTable">
    <thead>
      <tr>
        <th>Asset Code</th>
        <th>Photo</th>
        <th>Non-conformance</th>
        <th>Criticality</th>
        <th>Remedial Action</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  
  <!-- jsPDF from CDN for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <script>
    const DB_NAME = 'NonConformanceDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'entries';
    let db;
    let entries = [];
  
    // Open IndexedDB
    async function openDatabase() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = e => {
          db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
          }
        };
        request.onsuccess = e => {
          db = e.target.result;
          resolve(db);
        };
        request.onerror = e => reject(e.target.error);
      });
    }
  
    // Debounce function for filtering
    function debounce(fn, delay) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), delay);
      };
    }
  
    // (Optional) Update datalist suggestions ‚Äì you can load asset codes from a file if needed.
    function updateCodeSuggestions() {
      // For example, you could fetch asset codes and populate the datalist.
      // This demo leaves it empty.
    }
  
    // Render table entries with filter applied
    function renderEntries() {
      const tbody = document.querySelector('#entriesTable tbody');
      tbody.innerHTML = '';
      const filterText = document.getElementById('searchCodeInput').value.trim().toLowerCase();
      let filteredEntries = filterText 
        ? entries.filter(entry => entry.assetCode.toLowerCase().includes(filterText))
        : entries;
      // Limit to 50 rows for performance
      filteredEntries = filteredEntries.slice(0, 50);
  
      filteredEntries.forEach(entry => {
        const tr = document.createElement('tr');
  
        // Asset Code (editable)
        const assetTd = document.createElement('td');
        assetTd.setAttribute('data-label', 'Asset Code');
        const assetArea = document.createElement('textarea');
        assetArea.value = entry.assetCode;
        assetArea.rows = 1;
        assetArea.style.width = '100%';
        assetArea.oninput = () => {
          entry.assetCode = assetArea.value;
          updateEntry(entry);
        };
        assetTd.appendChild(assetArea);
        tr.appendChild(assetTd);
  
        // Photo
        const photoTd = document.createElement('td');
        photoTd.setAttribute('data-label', 'Photo');
        const img = document.createElement('img');
        img.src = entry.image;
        photoTd.appendChild(img);
        tr.appendChild(photoTd);
  
        // Non-conformance (editable)
        const nonConfTd = document.createElement('td');
        nonConfTd.setAttribute('data-label', 'Non-conformance');
        const nonConfArea = document.createElement('textarea');
        nonConfArea.value = entry.nonConformance;
        nonConfArea.rows = 2;
        nonConfArea.style.width = '100%';
        nonConfArea.oninput = () => {
          entry.nonConformance = nonConfArea.value;
          updateEntry(entry);
        };
        nonConfTd.appendChild(nonConfArea);
        tr.appendChild(nonConfTd);
  
        // Criticality (editable)
        const critTd = document.createElement('td');
        critTd.setAttribute('data-label', 'Criticality');
        const critSelect = document.createElement('select');
        ['low', 'medium', 'high'].forEach(level => {
          const option = document.createElement('option');
          option.value = level;
          option.textContent = level.toUpperCase();
          if(entry.criticality === level) option.selected = true;
          critSelect.appendChild(option);
        });
        critSelect.onchange = () => {
          entry.criticality = critSelect.value;
          updateEntry(entry);
        };
        critTd.appendChild(critSelect);
        tr.appendChild(critTd);
  
        // Remedial Action (editable)
        const remedTd = document.createElement('td');
        remedTd.setAttribute('data-label', 'Remedial Action');
        const remedArea = document.createElement('textarea');
        remedArea.value = entry.remedial;
        remedArea.rows = 2;
        remedArea.style.width = '100%';
        remedArea.oninput = () => {
          entry.remedial = remedArea.value;
          updateEntry(entry);
        };
        remedTd.appendChild(remedArea);
        tr.appendChild(remedTd);
  
        // Actions (Delete button)
        const actionsTd = document.createElement('td');
        actionsTd.setAttribute('data-label', 'Actions');
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => {
          if(confirm('Delete this entry?')) {
            deleteEntry(entry.id);
          }
        };
        actionsTd.appendChild(deleteBtn);
        tr.appendChild(actionsTd);
  
        tbody.appendChild(tr);
      });
    }
  
    // Update entry in IndexedDB
    function updateEntry(entry) {
      const transaction = db.transaction([STORE_NAME], 'readwrite');
      const store = transaction.objectStore(STORE_NAME);
      store.put(entry);
    }
  
    // Delete entry from IndexedDB
    function deleteEntry(id) {
      const transaction = db.transaction([STORE_NAME], 'readwrite');
      const store = transaction.objectStore(STORE_NAME);
      store.delete(id).onsuccess = () => refreshEntries();
    }
  
    // Refresh entries from IndexedDB
    async function refreshEntries() {
      const transaction = db.transaction([STORE_NAME], 'readonly');
      const store = transaction.objectStore(STORE_NAME);
      const request = store.getAll();
      request.onsuccess = () => {
        entries = request.result;
        renderEntries();
      };
    }
  
    // PDF Generation with complete rows per page
    document.getElementById('generatePdf').addEventListener('click', async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'pt', 'letter');
      const pageHeight = doc.internal.pageSize.height;
      const marginY = 40;
      const startX = 40;
      let currentY = marginY;
  
      // Define column widths for 5 columns: Asset Code, Photo, Non-conformance, Criticality, Remedial Action
      const colAssetW = 70;
      const colPhotoW = 120;
      const colNonConfW = 150;
      const colCritW = 60;
      const colRemedW = 100;
      const tableW = colAssetW + colPhotoW + colNonConfW + colCritW + colRemedW;
      const rowHeight = 130;
      const headerHeight = 30;
  
      // Draw table header
      function drawTableHeader() {
        drawRowBorder(currentY, headerHeight);
        doc.setFontSize(12);
        doc.text('Asset Code', startX + 5, currentY + 18);
        doc.text('Photo', startX + colAssetW + 5, currentY + 18);
        doc.text('Non-conf.', startX + colAssetW + colPhotoW + 5, currentY + 18);
        doc.text('Critical', startX + colAssetW + colPhotoW + colNonConfW + 5, currentY + 18);
        doc.text('Remedial', startX + colAssetW + colPhotoW + colNonConfW + colCritW + 5, currentY + 18);
        currentY += headerHeight;
      }
  
      // Draw row borders for a row
      function drawRowBorder(y, height) {
        doc.line(startX, y, startX + tableW, y);
        doc.line(startX, y + height, startX + tableW, y + height);
        doc.line(startX, y, startX, y + height);
        doc.line(startX + colAssetW, y, startX + colAssetW, y + height);
        doc.line(startX + colAssetW + colPhotoW, y, startX + colAssetW + colPhotoW, y + height);
        doc.line(startX + colAssetW + colPhotoW + colNonConfW, y, startX + colAssetW + colPhotoW + colNonConfW, y + height);
        doc.line(startX + colAssetW + colPhotoW + colNonConfW + colCritW, y, startX + colAssetW + colPhotoW + colNonConfW + colCritW, y + height);
        doc.line(startX + tableW, y, startX + tableW, y + height);
      }
  
      // Draw title and header
      doc.setFontSize(14);
      doc.text('Non-Conformance Report', startX, currentY - 10);
      drawTableHeader();
  
      // Filter entries for PDF based on asset code input
      const filterText = document.getElementById('searchCodeInput').value.trim().toLowerCase();
      const pdfEntries = filterText 
        ? entries.filter(entry => entry.assetCode.toLowerCase().includes(filterText))
        : entries;
  
      for (const entry of pdfEntries) {
        if (currentY + rowHeight > pageHeight - marginY) {
          doc.addPage();
          currentY = marginY;
          drawTableHeader();
        }
  
        drawRowBorder(currentY, rowHeight);
        doc.setFontSize(10);
  
        // Asset Code
        const assetX = startX + 5;
        const assetY = currentY + 20;
        const assetLines = doc.splitTextToSize(entry.assetCode, colAssetW - 10);
        doc.text(assetLines, assetX, assetY);
  
        // Photo
        const imgX = startX + colAssetW + 5;
        const maxImgWidth = colPhotoW - 10;
        const maxImgHeight = rowHeight - 10;
        try {
          const isPng = (entry.image || '').toLowerCase().includes('image/png');
          const format = isPng ? 'PNG' : 'JPEG';
          const props = doc.getImageProperties(entry.image);
          let iWidth = props.width;
          let iHeight = props.height;
          const ratio = Math.min(maxImgWidth / iWidth, maxImgHeight / iHeight);
          iWidth *= ratio;
          iHeight *= ratio;
          const yOffset = (rowHeight - iHeight) / 2;
          doc.addImage(entry.image, format, imgX, currentY + yOffset, iWidth, iHeight);
        } catch (err) {
          console.error('Image error:', err);
        }
  
        // Non-conformance
        const nonConfX = startX + colAssetW + colPhotoW + 5;
        const nonConfY = currentY + 20;
        const nonConfLines = doc.splitTextToSize(entry.nonConformance, colNonConfW - 10);
        doc.text(nonConfLines, nonConfX, nonConfY);
  
        // Criticality
        const critX = startX + colAssetW + colPhotoW + colNonConfW + 5;
        const critY = currentY + 20;
        doc.text(entry.criticality.toUpperCase(), critX, critY);
  
        // Remedial Action
        const remedX = startX + colAssetW + colPhotoW + colNonConfW + colCritW + 5;
        const remedY = currentY + 20;
        const remedLines = doc.splitTextToSize(entry.remedial, colRemedW - 10);
        doc.text(remedLines, remedX, remedY);
  
        currentY += rowHeight;
      }
  
      doc.save('non-conformance-report.pdf');
    });
  
    // Compress image utility
    async function compressImage(dataUrl, maxWidth = 1200, quality = 0.8) {
      return new Promise(resolve => {
        const img = new Image();
        img.src = dataUrl;
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;
          if (width > maxWidth) {
            height = (maxWidth / width) * height;
            width = maxWidth;
          }
          canvas.width = width;
          canvas.height = height;
          canvas.getContext('2d').drawImage(img, 0, 0, width, height);
          resolve(canvas.toDataURL('image/jpeg', quality));
        };
      });
    }
  
    // Form handling for adding a new entry
    document.getElementById('entryForm').addEventListener('submit', e => {
      e.preventDefault();
      const assetCode = document.getElementById('searchCodeInput').value.trim();
      const file = document.getElementById('imageInput').files[0];
      const nonConformance = document.getElementById('nonConformanceInput').value.trim();
      const criticality = document.getElementById('criticalityInput').value;
      const remedial = document.getElementById('remedialInput').value.trim();
  
      if (!assetCode) {
        alert('Please enter an Asset Code.');
        return;
      }
      if (!file) {
        alert('Please select a photo.');
        return;
      }
      if (!nonConformance || !remedial) {
        alert('Please fill out the Non-conformance and Remedial fields.');
        return;
      }
  
      const reader = new FileReader();
      reader.onload = async function(evt) {
        const imageData = await compressImage(evt.target.result);
        const newEntry = {
          assetCode,
          image: imageData,
          nonConformance,
          criticality,
          remedial,
          timestamp: Date.now()
        };
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.add(newEntry);
        request.onsuccess = () => {
          refreshEntries();
          e.target.reset();
        };
      };
      reader.readAsDataURL(file);
    });
  
    // Clear all entries
    document.getElementById('clearAll').addEventListener('click', () => {
      if (confirm('Clear ALL entries?')) {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        store.clear().onsuccess = () => refreshEntries();
      }
    });
  
    // Debounced filtering for the asset code input
    document.getElementById('searchCodeInput').addEventListener('input', debounce(() => {
      updateCodeSuggestions();
      renderEntries();
    }, 1000));
  
    // Initialize database and load entries
    openDatabase().then(refreshEntries);
  </script>
</body>
</html>
