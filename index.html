<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mobile Non-Conformance Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 10px;
      background: #f8f9fa;
      line-height: 1.6;
    }

    h1, h2 {
      text-align: center;
      margin: 15px 0;
      font-weight: 600;
    }

    h1 {
      font-size: 1.8rem;
      color: #1a73e8;
    }

    form, .buttons {
      margin: 15px 0;
      padding: 10px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: 500;
      color: #202124;
      font-size: 0.95rem;
    }

    input, select, button, textarea {
      width: 100%;
      padding: 12px;
      margin: 5px 0 15px;
      border: 1px solid #dadce0;
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      box-sizing: border-box;
    }

    button {
      background-color: #1a73e8;
      color: white;
      padding: 14px;
      border: none;
      transition: all 0.2s ease;
    }

    #clearAll {
      background-color: #dc3545;
    }

    /* Criticality colors */
    .criticality-low { color: #28a745; }
    .criticality-medium { color: #ffc107; }
    .criticality-high { color: #dc3545; }

    @media (max-width: 768px) {
      table tr { display: block; margin-bottom: 15px; }
      table td { display: flex; justify-content: space-between; }
      table td::before { content: attr(data-label); font-weight: 500; }
    }
  </style>
</head>
<body>
  <h1>Non-Conformance Tracker</h1>

  <label for="searchCodeInput">Asset Code:</label>
  <input type="text" id="searchCodeInput" placeholder="Search..." list="codeSuggestions" />
  <datalist id="codeSuggestions"></datalist>

  <form id="entryForm">
    <label for="imageInput">üì∏ Photo</label>
    <input type="file" id="imageInput" accept="image/*" capture="environment" required>

    <label for="nonConformanceInput">‚ö†Ô∏è Non-conformance</label>
    <textarea id="nonConformanceInput" required></textarea>

    <label for="criticalityInput">üö® Criticality</label>
    <select id="criticalityInput" required>
      <option value="low">Low</option>
      <option value="medium">Medium</option>
      <option value="high">High</option>
    </select>

    <label for="remedialInput">üîß Remedial Action</label>
    <textarea id="remedialInput" required></textarea>

    <button type="submit">‚ûï Add Entry</button>
  </form>

  <div class="buttons">
    <button id="generatePdf">üìÑ Generate PDF</button>
    <button id="clearAll">‚ùå Clear All</button>
  </div>

  <h2>Existing Entries</h2>
  <table id="entriesTable">
    <thead>
      <tr>
        <th>Asset Code</th>
        <th>Photo</th>
        <th>Non-conformance</th>
        <th>Criticality</th>
        <th>Remedial Action</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const DB_NAME = 'NonConformanceDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'entries';
    let db;
    let entries = [];

    // Database setup
    async function openDatabase() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = e => {
          db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
          }
        };
        request.onsuccess = e => {
          db = e.target.result;
          resolve(db);
        };
        request.onerror = e => reject(e.target.error);
      });
    }

    async function refreshEntries() {
      const transaction = db.transaction([STORE_NAME], 'readonly');
      const store = transaction.objectStore(STORE_NAME);
      entries = await new Promise(resolve => {
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
      });
      renderEntries();
    }

    function renderEntries() {
      const tbody = document.querySelector('#entriesTable tbody');
      tbody.innerHTML = '';
      
      entries.forEach(entry => {
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
          <td data-label="Asset Code">
            <textarea>${entry.assetCode}</textarea>
          </td>
          <td data-label="Photo">
            <img src="${entry.image}" />
          </td>
          <td data-label="Non-conformance">
            <textarea>${entry.nonConformance}</textarea>
          </td>
          <td data-label="Criticality" class="criticality-${entry.criticality}">
            ${entry.criticality.toUpperCase()}
          </td>
          <td data-label="Remedial">
            <textarea>${entry.remedial}</textarea>
          </td>
          <td data-label="Actions">
            <button class="delete-btn">Delete</button>
          </td>
        `;

        tr.querySelectorAll('textarea').forEach(ta => {
          ta.addEventListener('input', e => updateEntry(entry.id, e.target.parentElement.parentElement.cellIndex, e.target.value));
        });

        tr.querySelector('.delete-btn').addEventListener('click', () => {
          if (confirm('Delete this entry?')) {
            db.transaction([STORE_NAME], 'readwrite').objectStore(STORE_NAME).delete(entry.id);
            refreshEntries();
          }
        });

        tbody.appendChild(tr);
      });
    }

    async function updateEntry(id, fieldIndex, value) {
      const entry = entries.find(e => e.id === id);
      const field = ['assetCode', , 'nonConformance', 'criticality', 'remedial'][fieldIndex];
      if (field) entry[field] = value;
      await db.transaction([STORE_NAME], 'readwrite').objectStore(STORE_NAME).put(entry);
    }

    // PDF Generation
    document.getElementById('generatePdf').addEventListener('click', async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'pt', 'letter');
      const pageHeight = doc.internal.pageSize.height;
      let currentY = 40;

      const config = {
        colWidths: [80, 180, 140, 80, 140],
        rowHeight: 200,
        margin: 40
      };

      const drawHeader = () => {
        doc.setFontSize(14);
        doc.text('Non-Conformance Report', config.margin, 30);
        doc.setFontSize(10);
        const headers = ['Asset Code', 'Photo', 'Non-conformance', 'Criticality', 'Remedial'];
        headers.forEach((text, i) => doc.text(text, 
          config.margin + config.colWidths.slice(0,i).reduce((a,b)=>a+b,0), 
          currentY
        ));
        currentY += 20;
      };

      for (const entry of entries) {
        if (currentY + config.rowHeight > pageHeight - config.margin) {
          doc.addPage();
          currentY = config.margin;
          drawHeader();
        }

        // Compress image
        const imgData = await compressImage(entry.image);
        const imgProps = doc.getImageProperties(imgData);
        const imgWidth = config.colWidths[1] - 10;
        const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

        doc.addImage(imgData, 'JPEG', 
          config.margin + config.colWidths[0] + 5, 
          currentY + 5, 
          imgWidth, 
          Math.min(imgHeight, config.rowHeight - 10)
        );

        // Text content
        const textContent = [
          entry.assetCode,
          entry.nonConformance,
          entry.criticality.toUpperCase(),
          entry.remedial
        ];

        textContent.forEach((text, i) => {
          const x = config.margin + [0, config.colWidths[1], ...config.colWidths.slice(2)].slice(0,i+1).reduce((a,b)=>a+b,0);
          doc.setFillColor(i === 2 ? getCriticalityColor(entry.criticality) : 255);
          doc.rect(x, currentY, config.colWidths[i+(i>1?1:0)], config.rowHeight, 'F');
          doc.text(text, x + 5, currentY + 15, {
            maxWidth: config.colWidths[i+(i>1?1:0)] - 10
          });
        });

        currentY += config.rowHeight;
      }

      doc.save('non-conformance-report.pdf');
    });

    function getCriticalityColor(criticality) {
      return {
        low: '#28a745',
        medium: '#ffc107',
        high: '#dc3545'
      }[criticality];
    }

    async function compressImage(dataUrl, maxWidth = 1200, quality = 0.8) {
      return new Promise(resolve => {
        const img = new Image();
        img.src = dataUrl;
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;
          
          if (width > maxWidth) {
            height = (maxWidth / width) * height;
            width = maxWidth;
          }

          canvas.width = width;
          canvas.height = height;
          canvas.getContext('2d').drawImage(img, 0, 0, width, height);
          resolve(canvas.toDataURL('image/jpeg', quality));
        };
      });
    }

    // Form handling
    document.getElementById('entryForm').addEventListener('submit', async e => {
      e.preventDefault();
      
      const reader = new FileReader();
      reader.readAsDataURL(document.getElementById('imageInput').files[0]);
      
      reader.onload = async () => {
        const entry = {
          assetCode: document.getElementById('searchCodeInput').value.trim(),
          nonConformance: document.getElementById('nonConformanceInput').value.trim(),
          criticality: document.getElementById('criticalityInput').value,
          remedial: document.getElementById('remedialInput').value.trim(),
          image: await compressImage(reader.result)
        };

        await db.transaction([STORE_NAME], 'readwrite').objectStore(STORE_NAME).add(entry);
        refreshEntries();
        e.target.reset();
      };
    });

    // Clear all entries
    document.getElementById('clearAll').addEventListener('click', () => {
      if (confirm('Clear ALL entries?')) {
        db.transaction([STORE_NAME], 'readwrite').objectStore(STORE_NAME).clear();
        refreshEntries();
      }
    });

    // Initialize
    openDatabase().then(refreshEntries);
  </script>
</body>
</html>